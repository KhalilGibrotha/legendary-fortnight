schemaVersion: 2.2.0
metadata:
  name: python-env-builder
components:
  - name: python-builder
    container:
      image: quay.io/ansible/ansible-creator-ee:latest # Or your preferred Ansible starting image
      memoryLimit: 8Gi
      cpuLimit: 4000m
      mountSources: true
      env:
        - name: MAMBA_ROOT_PREFIX
          value: /projects/.mamba
commands:
  - id: install-mamba
    exec:
      component: python-builder
      commandLine: |
        if [ ! -f /projects/bin/micromamba ]; then
          echo "Installing Micromamba to /projects/bin..."
          mkdir -p /projects/bin
          curl -Ls https://micro.mamba.pm/api/micromamba/linux-64/latest | tar -xj -C /projects/bin --strip-components=1 bin/micromamba
        fi
  - id: build-env
    exec:
      component: python-builder
      commandLine: |
        /projects/bin/micromamba create -y -p /projects/rm_env -f /projects/environment.yml
        echo "Environment built at /projects/rm_env"
events:
  postStart:
    - install-mamba
    - build-env